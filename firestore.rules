rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is an owner or admin
    function isAdmin() {
      return request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'owner' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'
      );
    }

    match /users/{userId} {
      // Users can read their own profile; Admins can read all
      allow read: if request.auth != null && (request.auth.uid == userId || isAdmin());
      
      // Users can create their own profile (during sign-up)
      allow create: if request.auth != null && request.auth.uid == userId;

      // Users can update their own profile EXCEPT 'role' and 'credits'
      allow update: if request.auth != null && (
        (request.auth.uid == userId && (
           (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['credits', 'role'])) || 
           (request.resource.data.role == 'owner' && resource.data.role != 'owner')
        )) || 
        isAdmin()
      );
      
      // Sub-collection for Video Analyses
      match /video_analyses/{analysisId} {
         allow read: if request.auth != null && (request.auth.uid == userId || isAdmin());
         // Writes are done by Admin SDK (Cloud Functions), so we don't strictly need write access here for users
         // unless we want them to delete their own.
         allow write: if isAdmin(); 
      }

      // Sub-collection for App/Game data (scores, progress, etc.)
      match /apps/{appId} {
         // Users can read and write their own app data
         allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }

    match /creations/{creationId} {
      // Users can read their own creations; Owners can read all
      allow read: if request.auth != null && (resource.data.userId == request.auth.uid || isAdmin());
    }

    match /pages/{pageId} {
      // CMS Pages: Public read, Admin write
      allow read: if true;
      allow write: if isAdmin();
    }

    match /config/{configId} {
      // UI Settings: Public read, Admin write
      allow read: if true;
      allow write: if isAdmin();
    }

    match /item_views/{itemId} {
      // View counts: Public read, no auth required for incrementing
      // Rate limited: max 10 writes per minute per IP to prevent abuse
      allow read: if true;
      allow write: if request.auth != null || 
        (request.resource.data.keys().hasAll(['count', 'itemId']) && 
         request.resource.data.count is int &&
         request.resource.data.count == resource.data.count + 1);
    }
  }
}
